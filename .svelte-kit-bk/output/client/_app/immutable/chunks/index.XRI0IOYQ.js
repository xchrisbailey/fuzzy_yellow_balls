import{b as _e,c as Ne,e as Le,d as Re,f as le}from"./forms.gowbjPrN.js";import{p as ae}from"./stores.ChxPK_Za.js";import{k as re,w as q}from"./singletons.88_YLMnZ.js";import{v as w,a2 as ye,t as Se}from"./scheduler.t4ki4vww.js";import{p as Ue}from"./parse.RrI1B0B4.js";import{s as Te}from"./stringify.zTK2Chiw.js";const Ie=!0,Ae=Ie;function oe(e){return e.toString().split(/[[\].]+/).filter(t=>t)}function Fe(e){return e.reduce((t,a)=>{const i=String(a);return typeof a=="number"||/^\d+$/.test(i)?t+=`[${i}]`:t?t+=`.${i}`:t+=i,t},"")}class I extends Error{constructor(t){super(t),Object.setPrototypeOf(this,I.prototype)}}function ue(e,t,a){return e[t]=a,"skip"}function he(e,t){return t.value!==void 0&&typeof t.value!="object"&&t.path.length<e.length}function we(e,t,a={}){a.modifier||(a.modifier=s=>he(t,s)?void 0:s.value);const i=N(e,t,a.modifier);if(i)return a.value===void 0||a.value(i.value)?i:void 0}function N(e,t,a){if(!t.length)return;const i=[t[0]];let s=e;for(;i.length<t.length;){const r=i[i.length-1],f=a?a({parent:s,key:String(r),value:s[r],path:i.map(u=>String(u)),isLeaf:!1,set:u=>ue(s,r,u)}):s[r];if(f===void 0)return;s=f,i.push(t[i.length])}const o=t[t.length-1];return{parent:s,key:String(o),value:s[o],path:t.map(r=>String(r)),isLeaf:!0,set:r=>ue(s,o,r)}}function B(e,t,a=[]){for(const i in e){const s=e[i],o=s===null||typeof s!="object",r={parent:e,key:i,value:s,path:a.map(String).concat([i]),isLeaf:o,set:u=>ue(e,i,u)},f=t(r);if(f==="abort")return f;if(f==="skip")continue;if(!o){const u=B(s,t,r.path);if(u==="abort")return u}}}async function Oe(e,t,a=[]){for(const i in e){const s=e[i],o=s===null||typeof s!="object",r={parent:e,key:i,value:s,path:a.map(String).concat([i]),isLeaf:o,set:u=>ue(e,i,u)},f=await t(r);if(f==="abort")return f;if(f==="skip")break;if(!o){const u=B(s,t,r.path);if(u==="abort")return u}}}function Ze(e,t){return e===t||e.size===t.size&&[...e].every(a=>t.has(a))}function De(e,t){const a=new Map;function i(s,o){const r=N(o,s.path);function f(){a.set(s.path.join(" "),s.path)}s.isLeaf?r?s.value!==r.value&&f():f():r&&(s.value instanceof Date&&r.value instanceof Date&&s.value.getTime()!=r.value.getTime()||s.value instanceof Set&&r.value instanceof Set&&!Ze(s.value,r.value))&&f()}return B(e,s=>i(s,t)),B(t,s=>i(s,e)),Array.from(a.values())}function Y(e,t,a){for(const i of t){const s=N(e,i,({parent:o,key:r,value:f})=>((f===void 0||typeof f!="object")&&(o[r]={}),o[r]));s&&(s.parent[s.key]=a)}}function de(e,t){const a=oe(t),i=re(e,s=>N(s,a)?.value);return{subscribe(...s){const o=i.subscribe(...s);return()=>o()},update(s){e.update(o=>{const r=N(o,a,({parent:f,key:u,value:y})=>(y===void 0&&(f[u]=/\D/.test(u)?{}:[]),f[u]));return r&&(r.parent[r.key]=s(r.value)),o})},set(s){e.update(o=>{const r=N(o,a,({parent:f,key:u,value:y})=>(y===void 0&&(f[u]=/\D/.test(u)?{}:[]),f[u]));return r&&(r.parent[r.key]=s),o})}}}function G(e){return"structuredClone"in globalThis?structuredClone(e):Ue(Te(e))}function qe(e){const t=e;let a=!0,i=!1,s=!1,o=!1,r,f;for(;a;)switch(e._def.typeName){case"ZodNullable":i=!0,e=e.unwrap();break;case"ZodDefault":o=!0,f=e._def.defaultValue(),e=e._def.innerType;break;case"ZodOptional":s=!0,e=e.unwrap();break;case"ZodEffects":r||(r=e),e=e._def.schema;break;case"ZodPipeline":e=e._def.out;break;case"ZodBranded":e=e.unwrap();break;default:a=!1}return{zodType:e,originalType:t,isNullable:i,isOptional:s,hasDefault:o,defaultValue:f,effects:r}}const ce=new WeakMap;function ge(e){return ce.has(e)||ce.set(e,ne(e)),ce.get(e)}function ne(e){const t=qe(e).zodType;if(t._def.typeName=="ZodObject")return Object.fromEntries(Object.entries(t.shape).map(([a,i])=>[a,ne(i)]).filter(a=>a[1]!==void 0));if(t._def.typeName=="ZodArray")return ne(t._def.type)??{};if(t._def.typeName=="ZodRecord")return ne(t._def.valueType)??{};if(t._def.typeName=="ZodUnion")return t._def.options.reduce((i,s)=>{const o=ne(s);return o&&(i={...i??{},...o}),i},void 0)}function fe(e,t,a=!0){const i={},s=Object.entries(e);if("_errors"in e&&e._errors.length){if(!t||!a)return e._errors;i._errors=e._errors}for(const[o,r]of s.filter(([f])=>f!=="_errors")){const f=/^\d+$/.test(o);i[o]=fe(r,t?f?t:t[o]:void 0,!!t?.[o])}return i}function He(e){return Me(e,[])}function Me(e,t){return Object.entries(e).filter(([,i])=>i!==void 0).flatMap(([i,s])=>{if(Array.isArray(s)&&s.length>0){const o=t.concat([i]);return{path:Fe(o),messages:s}}else return Me(e[i],t.concat([i]))})}function ve(e,t){e.update(a=>(B(a,i=>{if(!(i.path.length==1&&i.path[0]=="_errors"&&!t.clearFormLevelErrors)&&Array.isArray(i.value))return i.set(void 0)}),t.undefinePath&&Y(a,[t.undefinePath],void 0),a))}async function Pe(e,t,a,i,s){return $e(e,t,a,i,s)}async function $e(e,t,a,i,s){let o=!0,r={};if(e)if("safeParseAsync"in e){const f=e,u=await f.safeParseAsync(t);o=u.success,u.success?t=u.data:r=fe(u.error.format(),ge(f))}else{t={...t};for(const[y,_]of Object.entries(e))typeof _=="function"&&!(y in t)&&(t[y]=void 0);const f=e,u=[];await Oe(t,async({value:y,path:_})=>{const T=_.filter(b=>/\D/.test(String(b))),d=N(f,T);if(typeof d?.value=="function"){const b=d.value;let E;if(Array.isArray(y))for(const O in y)try{E=await b(y[O]),E&&(o=!1,u.push({path:_.concat([O]),errors:typeof E=="string"?[E]:E??void 0}))}catch(Z){o=!1,console.error(`Error in form validators for field "${_}":`,Z)}else try{E=await b(y),E&&(o=!1,u.push({path:_,errors:typeof E=="string"?[E]:E??void 0}))}catch(O){o=!1,console.error(`Error in form validators for field "${_}":`,O)}}});for(const{path:y,errors:_}of u){const T=N(r,y,({parent:d,key:b,value:E})=>(E===void 0&&(d[b]={}),d[b]));if(T){const{parent:d,key:b}=T;d[b]=_}}}return{valid:o,posted:s,errors:r,data:t,constraints:i,message:void 0,id:a}}async function Be(e,t,a,i){if(typeof e.validators!="object"||!("safeParseAsync"in e.validators))return;const s=e.validators,o=await s.safeParseAsync(w(t));if(o.success)a.update(r=>(B(r,f=>{if(f.key=="_errors")return f.set(void 0)}),r));else{const r=fe(o.error.format(),ge(s));a.update(f=>(B(f,u=>{if(u.key=="_errors")return u.set(void 0)}),B(r,u=>{if(u.key=="_errors"){const y=u.path.length==1?{value:!0}:i&&N(i,u.path.slice(0,-1));if(y&&y.value)return Y(f,[u.path],u.value)}}),f))}}async function me(e,t,a,i,s,o={}){function r(){ve(i,{undefinePath:e,clearFormLevelErrors:!0})}function f(y){return typeof y=="string"&&(y=[y]),(o.update===!0||o.update=="errors")&&i.update(_=>{const T=N(_,e,d=>{if(he(e,d))throw new I("Errors can only be added to form fields, not to arrays or objects in the schema. Path: "+d.path.slice(0,-1));return d.value===void 0?(d.parent[d.key]={},d.parent[d.key]):d.value});if(!T)throw new I("Error path could not be created: "+e);return T.parent[T.key]=y??void 0,_}),y??void 0}const u=await We(e,t.validators,a,i,s,o);return u.validated?u.validated==="all"&&!u.errors?r():u.errors=f(u.errors):u.validated===!1&&t.defaultValidator=="clear"&&(u.errors=f(u.errors)),u}async function We(e,t,a,i,s,o={}){o.update===void 0&&(o.update=!0),o.taint===void 0&&(o.taint=!1),typeof o.errors=="string"&&(o.errors=[o.errors]);const r={value:o.value,shouldUpdate:!0,currentData:void 0,validationPath:e.filter(d=>/\D/.test(String(d)))};async function f(){return{validated:!1,errors:void 0,data:void 0}}function u(d,b){if(b===void 0)return!1;const E=N(b,d);return E?E.value:!1}function y(d){i.update(d)}function _(){ve(i,{undefinePath:null,clearFormLevelErrors:!0})}function T(d,b){return fe(d.format(),ge(b))}if("value"in o)o.update===!0||o.update==="value"?a.update(d=>(Y(d,[e],r.value),r.currentData=d),{taint:o.taint}):r.shouldUpdate=!1;else{r.currentData=w(a);const d=N(r.currentData,e);r.value=d?.value}if(typeof t!="object")return f();if("safeParseAsync"in t){r.shouldUpdate||(r.currentData=G(r.currentData??w(a)),Y(r.currentData,[e],r.value));const d=await t.safeParseAsync(r.currentData);if(d.success)return _(),{validated:!0,errors:void 0,data:d.data};{const b=T(d.error,t);if(o.update===!0||o.update=="errors"){const O=w(s);y(Z=>(B(Z,F=>{if(F.key=="_errors")return F.set(void 0)}),B(b,F=>{if(F.key=="_errors"&&(F.path.length==1||u(F.path.slice(0,-1),O)))return Y(Z,[F.path],F.value);if(Array.isArray(F.value))return u(F.path,O)&&Y(Z,[F.path],F.value),"skip"}),Z))}const E=N(b,e);return{validated:!0,errors:o.errors??E?.value,data:void 0}}}else{const d=N(t,r.validationPath);if(!d||d.value===void 0)return f();{const b=await d.value(r.value);return{validated:!0,errors:b&&(o.errors??b),data:void 0}}}}const Ke=(e,t=0)=>{const a=e.getBoundingClientRect();return a.top>=t&&a.left>=0&&a.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&a.right<=(window.innerWidth||document.documentElement.clientWidth)},Xe=(e,t=1.125,a="smooth")=>{const o=e.getBoundingClientRect().top+window.pageYOffset-window.innerHeight/(2*t);window.scrollTo({left:0,top:o,behavior:a})};var j;(function(e){e[e.Idle=0]="Idle",e[e.Submitting=1]="Submitting",e[e.Delayed=2]="Delayed",e[e.Timeout=3]="Timeout"})(j||(j={}));const Ye=new Set;let pe=!1;function Ge(e,t,a){let i=j.Idle,s,o,r=!1;const f=Ye;function u(){y(),T(i!=j.Delayed?j.Submitting:j.Delayed),s=window.setTimeout(()=>{s&&i==j.Submitting&&T(j.Delayed)},a.delayMs),o=window.setTimeout(()=>{o&&i==j.Delayed&&T(j.Timeout)},a.timeoutMs),f.add(y)}function y(){clearTimeout(s),clearTimeout(o),s=o=0,f.delete(y),T(j.Idle)}function _(){f.forEach(g=>g()),f.clear()}function T(g){i=g,t.submitting.set(i>=j.Submitting),t.delayed.set(i>=j.Delayed),t.timeout.set(i>=j.Timeout)}const d=e;function b(g){const P=g.target;a.selectErrorText&&P.select()}function E(){a.selectErrorText&&d.querySelectorAll("input").forEach(g=>{g.addEventListener("invalid",b)})}function O(){a.selectErrorText&&d.querySelectorAll("input").forEach(g=>g.removeEventListener("invalid",b))}const Z=e;function F(g){return typeof a.autoFocusOnError=="boolean"?a.autoFocusOnError:!/iPhone|iPad|iPod|Android/i.test(g)}const J=async()=>{if(a.scrollToError=="off")return;const g=a.errorSelector;if(!g)return;await Se();let P;if(P=Z.querySelector(g),!P)return;P=P.querySelector(g)??P;const W=a.stickyNavbar?document.querySelector(a.stickyNavbar):null;if(typeof a.scrollToError!="string"?P.scrollIntoView(a.scrollToError):Ke(P,W?.offsetHeight??0)||Xe(P,void 0,a.scrollToError),!F(navigator.userAgent))return;let L;if(L=P,["INPUT","SELECT","BUTTON","TEXTAREA"].includes(L.tagName)||(L=L.querySelector('input:not([type="hidden"]):not(.flatpickr-input), select, textarea')),L)try{L.focus({preventScroll:!0}),a.selectErrorText&&L.tagName=="INPUT"&&L.select()}catch{}};{E();const g=(P,W=!1)=>{y(),P||setTimeout(J),W&&!r&&_()};return ye(()=>{O(),g(!0)}),pe||(_e(()=>{r=!0}),Ne(P=>{P.type!="enter"&&(r=!1,_())}),pe=!0),{submitting:()=>{r=!1,u()},completed:g,scrollToFirstError:()=>{setTimeout(J)},isSubmitting:()=>i===j.Submitting||i===j.Delayed}}}function Ee(e){!e.flashMessage||!Ae||be(e)&&(document.cookie=`flash=; Max-Age=0; Path=${e.flashMessage.cookiePath??"/"};`)}function be(e){return!e.flashMessage||!Ae?!1:e.syncFlashMessage}const ke="noCustomValidity";function Ve(e,t){const a=t&&t.length?t.join(`
`):"";e.setCustomValidity(a),a&&e.reportValidity()}function Je(e,t){for(const a of e.querySelectorAll("input,select,textarea,button")){if(ke in a.dataset)continue;const i=N(t,oe(a.name));if(Ve(a,i?.value),i?.value)return}}function Qe(e,t,a,i,s,o,r,f,u,y,_,T,d,b,E,O,Z){y();const F=s;async function J(m,V,S){r.customValidity&&r.validationMethod!="submit-only"&&("setCustomValidity"in m&&m.setCustomValidity(""),!(V=="input"&&r.validationMethod=="onblur")&&(ke in m.dataset||Ve(m,S)))}async function g(m,V,S){if(r.validationMethod=="submit-only")return;const A=await me(m,r,f,F,b);if(A.data&&S&&f.set(A.data),r.customValidity){const R=CSS.escape(Fe(m)),D=e.querySelector(`[name="${R}"]`);D&&J(D,V,A.errors)}}const P=["checkbox","radio","range"];function W(m){return m&&(m instanceof HTMLSelectElement||m instanceof HTMLInputElement&&P.includes(m.type))}async function L(m){if(r.validationMethod=="oninput"||r.validationMethod=="submit-only")return;const V=W(m.target);V&&await new Promise(R=>setTimeout(R,0));const S=w(E);if(!S.length)return;const A=m.target instanceof HTMLElement?m.target:null;for(const R of S)g(R,"blur",V?null:A);E.set([])}async function ee(m){if(r.validationMethod=="onblur"||r.validationMethod=="submit-only")return;const V=W(m.target);V&&await new Promise(R=>setTimeout(R,0));const S=w(E);if(!S.length)return;const A=m.target instanceof HTMLElement?m.target:null;for(const R of S){const D=V||N(w(F),R);(V||typeof D=="object"&&D.key in D.parent)&&setTimeout(()=>g(R,"input",V?A:null),0)}}e.addEventListener("focusout",L),e.addEventListener("input",ee),ye(()=>{e.removeEventListener("focusout",L),e.removeEventListener("input",ee)});const H=Ge(e,{submitting:t,delayed:a,timeout:i},r);let $;return Le(e,async m=>{const V=m.cancel;let S=!1;function A(U=!0){return S=!0,U&&H.isSubmitting()&&H.completed(!0),V()}if(m.cancel=A,H.isSubmitting()&&r.multipleSubmits=="prevent")A(!1);else{H.isSubmitting()&&r.multipleSubmits=="abort"&&$&&$.abort(),H.submitting(),$=m.controller;for(const U of _.onSubmit)await U(m)}if(S)r.flashMessage&&Ee(r);else{const U=!r.SPA&&(e.noValidate||(m.submitter instanceof HTMLButtonElement||m.submitter instanceof HTMLInputElement)&&m.submitter.formNoValidate),v=await Pe(U?void 0:r.validators,w(f),w(T),w(d),w(Z));if(!v.valid){A(!1);const M={type:"failure",status:(typeof r.SPA=="boolean"?void 0:r.SPA?.failStatus)??400,data:{form:v}};setTimeout(()=>D({result:M}),0)}if(!S){switch(r.clearOnSubmit){case"errors-and-message":F.clear(),u.set(void 0);break;case"errors":F.clear();break;case"message":u.set(void 0);break}r.flashMessage&&(r.clearOnSubmit=="errors-and-message"||r.clearOnSubmit=="message")&&be(r)&&r.flashMessage.module.getFlash(ae).set(void 0);const M="formData"in m?m.formData:m.data;if(r.SPA){A(!1);const C={...v,posted:!0},k={type:C.valid?"success":"failure",status:C.valid?200:typeof r.SPA=="object"?r.SPA?.failStatus:400,data:{form:C}};setTimeout(()=>D({result:k}),0)}else if(r.dataType==="json"){const C=v.data,k=R(Te(C),r.jsonChunkSize??5e5);for(const x of k)M.append("__superform_json",x);Object.keys(C).forEach(x=>{typeof M.get(x)=="string"&&M.delete(x)})}if(!r.SPA&&!M.has("__superform_id")){const C=w(T);C!==void 0&&M.set("__superform_id",C)}}}function R(U,v){const M=Math.ceil(U.length/v),C=new Array(M);for(let k=0,x=0;k<M;++k,x+=v)C[k]=U.substring(x,x+v);return C}async function D(U){const v=U.result.type?U.result:{type:"error",status:500,error:U.result};$=null;let M=!1;const C={result:v,formEl:e,cancel:()=>M=!0};for(const k of _.onResult)await k(C);if(!M){if((v.type==="success"||v.type=="failure")&&v.data){const k=O(v.data);if(!k.length)throw new I("No form data returned from ActionResult. Make sure you return { form } in the form actions.");for(const x of k){if(x.id!==w(T))continue;const ie={form:x,formEl:e,cancel:()=>M=!0};for(const Q of _.onUpdate)await Q(ie);!M&&r.customValidity&&Je(e,ie.form.errors)}}if(!M){if(v.type!=="error")v.type==="success"&&r.invalidateAll&&await Re(),r.applyAction?await le(v):await o(v);else{if(r.applyAction)if(r.onError=="apply")await le(v);else{const k={type:"failure",status:Math.floor(v.status||500),data:v};await le(k)}if(r.onError!=="apply"){const k={result:v,message:u};for(const x of _.onError)x!=="apply"&&(x!=Ce||!r.flashMessage?.onError)&&await x(k)}}r.flashMessage&&v.type=="error"&&r.flashMessage.onError&&await r.flashMessage.onError({result:v,message:r.flashMessage.module.getFlash(ae)})}}M&&r.flashMessage&&Ee(r),M||v.type!="redirect"?H.completed(M):v.type=="redirect"&&new URL(v.location,/^https?:\/\//.test(v.location)?void 0:document.location.origin).pathname==document.location.pathname&&setTimeout(()=>{H.completed(!0,!0)},0)}return D})}new TextEncoder;const Ce=e=>{console.warn("Unhandled Superform error, use onError event to handle it:",e.result.error)},ze={applyAction:!0,invalidateAll:!0,resetForm:!1,autoFocusOnError:"detect",scrollToError:"smooth",errorSelector:'[aria-invalid="true"],[data-invalid]',selectErrorText:!1,stickyNavbar:void 0,taintedMessage:"Do you want to leave this page? Changes you made may not be saved.",onSubmit:void 0,onResult:void 0,onUpdate:void 0,onUpdated:void 0,onError:Ce,dataType:"form",validators:void 0,defaultValidator:"keep",customValidity:!1,clearOnSubmit:"errors-and-message",delayMs:500,timeoutMs:8e3,multipleSubmits:"prevent",validation:void 0,SPA:void 0,validateMethod:"auto"},se=new WeakMap,z=new WeakMap;function et(e){return`Duplicate form id's found: "${e}". Multiple forms will receive the same data. Use the id option to differentiate between them, or if this is intended, set the warnings.duplicateId option to false in superForm to disable this warning. More information: https://superforms.rocks/concepts/multiple-forms`}function ot(e,t={}){t={...ze,...t},t.SPA&&t.validators===void 0&&console.warn("No validators set for superForm in SPA mode. Add them to the validators option, or set it to false to disable this warning.");let a=t.id;!e||b(e)===!1?(t.warnings?.noValidationAndConstraints!==!1&&console.warn((e?"Form data sent directly to superForm instead of through superValidate. No initial data validation is made. ":"No form data sent to superForm, schema type safety cannot be guaranteed. ")+"Also, no constraints will exist for the form. Set the warnings.noValidationAndConstraints option to false to disable this warning."),e={valid:!1,posted:!1,errors:{},data:e??{},constraints:{}}):a===void 0&&(a=e.id);const i=a,s=w(ae);if(t.warnings?.duplicateId!==!1)if(!se.has(s))se.set(s,new Set([i]));else{const n=se.get(s);n?.has(i)?console.warn(et(i)):n?.add(i)}z.has(e)||z.set(e,G(e));const o=z.get(e);if(typeof o.valid!="boolean")throw new I("A non-validation object was passed to superForm. It should be an object of type SuperValidated, usually returned from superValidate.");s.form,e=G(o);const r=e,f=q(r.errors),u=q(a),y={taintedMessage:t.taintedMessage,taintedFormState:G(o.data)};function _(n=8){return Math.random().toString(36).substring(2,n+2)}function T(n){y.taintedFormState=G(n)}function d(n){return Object.values(n).filter(c=>b(c)!==!1)}function b(n){return!n||typeof n!="object"||!("valid"in n&&"errors"in n&&typeof n.valid=="boolean")?!1:"id"in n&&typeof n.id=="string"?n.id:void 0}function E(){t.taintedMessage=y.taintedMessage,a===void 0&&u.set(_())}function O(n){const l=q(n);return{subscribe:l.subscribe,set:(c,h={})=>(v(c,y.taintedFormState,h.taint??!0),T(c),l.set(G(c))),update:(c,h={})=>l.update(p=>{const X=c(p);return v(X,y.taintedFormState,h.taint??!0),T(X),X})}}const Z=[u.subscribe(n=>a=n)];function F(n){Z.push(n)}function J(){Z.forEach(n=>n())}const g=O(r.data);function P(n,l){if(!(!l||typeof l!="object")){if(Array.isArray(l))l.length>0&&P(n,l[0]);else if(!(l instanceof Date))throw new I(`Object found in form field "${n}". Set the dataType option to "json" and add use:enhance to use nested data structures. More information: https://superforms.rocks/concepts/nested-data`)}}async function W(n,l){n.valid&&l&&t.resetForm&&(t.resetForm===!0||t.resetForm())?L(n.message):Q(n,l),K.onUpdated.length&&await Se();for(const c of K.onUpdated)c({form:n})}function L(n,l,c){const h=G(o);h.data={...h.data,...l},c!==void 0&&(h.id=c),Q(h,!0,n)}const ee=async(n,l)=>{if(n.type=="error")throw new I(`ActionResult of type "${n.type}" cannot be passed to update function.`);if(n.type=="redirect"){t.resetForm&&(t.resetForm===!0||t.resetForm())&&L();return}if(typeof n.data!="object")throw new I("Non-object validation data returned from ActionResult.");const c=d(n.data);if(!c.length)throw new I("No form data returned from ActionResult. Make sure you return { form } in the form actions.");for(const h of c)h.id===a&&await W(h,l??(n.status>=200&&n.status<300))},H=q([]),$=q(r.message),m=q(r.constraints),V=q(!1),S={subscribe:f.subscribe,set:f.set,update:f.update,clear:()=>ve(f,{undefinePath:null,clearFormLevelErrors:!0})},A=q();function R(){return w(A)}function D(n){if(n===null)throw new I("$tainted store contained null");if(typeof n=="object"){for(const l of Object.values(n))if(D(l))return!0}return n===!0}async function U(n,l){let c=t.validationMethod==="oninput";if(!c){const h=w(S),p=h?we(h,n,{modifier:te=>{if(he(n,te))throw new I("Errors can only be added to form fields, not to arrays or objects in the schema. Path: "+te.path.slice(0,-1));return te.value}}):void 0;c=!!(p&&p.key in p.parent)}return c?(await me(n,t,g,S,A,{taint:l}),!0):!1}async function v(n,l,c){if(c=="ignore")return;let h=De(n,l);if(typeof c=="object"&&(typeof c.fields=="string"&&(c.fields=[c.fields]),h=c.fields.map(p=>oe(p)),c=!0),H.set(h),h.length&&(c==="untaint-all"?A.set(void 0):A.update(p=>{if(c!==!0&&p){const X=p;h=h.filter(te=>we(X,te)),h.length&&(p||(p={}),Y(p,h,void 0))}else c===!0&&(p||(p={}),Y(p,h,!0));return p}),!(t.validationMethod=="onblur"||t.validationMethod=="submit-only"))){let p=!1;for(const X of h)p=p||await U(X,c);p||await Be(t,g,S,w(A))}}function M(n,l){A.set(n),T(l)}const C=q(!1),k=q(!1),x=q(!1),ie=re(S,n=>n?He(n):[]);if(t.taintedMessage=void 0,ye(()=>{J();for(const n of Object.values(K))n.length=0;se.get(s)?.delete(i)}),t.dataType!=="json")for(const[n,l]of Object.entries(r.data))P(n,l);function Q(n,l,c){if(l&&M(typeof l=="boolean"?void 0:l,n.data),c=c??n.message,g.set(n.data,{taint:"ignore"}),$.set(c),S.set(n.errors),u.set(n.id),V.set(n.posted),t.flashMessage&&be(t)){const h=t.flashMessage.module.getFlash(ae);c&&w(h)===void 0&&h.set(c)}}const K={onSubmit:t.onSubmit?[t.onSubmit]:[],onResult:t.onResult?[t.onResult]:[],onUpdate:t.onUpdate?[t.onUpdate]:[],onUpdated:t.onUpdated?[t.onUpdated]:[],onError:t.onError?[t.onError]:[]};_e(n=>{if(t.taintedMessage&&!w(C)){const l=R();l&&D(l)&&!window.confirm(t.taintedMessage)&&n.cancel()}}),F(ae.subscribe(async n=>{if(!t.applyAction)return;t.SPA&&await new Promise(c=>setTimeout(c,0));const l=n.status>=200&&n.status<300;if(n.form&&typeof n.form=="object"){const c=n.form;if(c.type=="error")return;const h=d(c);for(const p of h)p.id!==a||z.has(p)||(z.set(p,p),await W(p,l))}else if(n.data&&typeof n.data=="object"){const c=d(n.data);for(const h of c)h.id!==a||z.has(h)||Q(h,l)}}));const xe=Object.fromEntries(Object.keys(o.data).map(n=>[n,{name:n,value:de(g,n),errors:de(S,n),constraints:de(m,n)}]));async function je(n,l){return n===void 0?Pe(t.validators,w(g),a,w(m),!1):(await me(oe(n),t,g,S,A,l)).errors}return{form:g,formId:u,errors:S,message:$,constraints:m,fields:xe,tainted:A,submitting:re(C,n=>n),delayed:re(k,n=>n),timeout:re(x,n=>n),options:t,capture:function(){return{valid:o.valid,posted:w(V),errors:w(S),data:w(g),constraints:w(m),message:w($),id:a,tainted:w(A)}},restore:function(n){return Q(n,n.tainted??!0)},validate:je,enhance:(n,l)=>{if(l){if(l.onError){if(t.onError==="apply")throw new I('options.onError is set to "apply", cannot add any onError events.');if(l.onError==="apply")throw new I('Cannot add "apply" as onError event in use:enhance.');K.onError.push(l.onError)}l.onResult&&K.onResult.push(l.onResult),l.onSubmit&&K.onSubmit.push(l.onSubmit),l.onUpdate&&K.onUpdate.push(l.onUpdate),l.onUpdated&&K.onUpdated.push(l.onUpdated)}return Qe(n,C,k,x,S,ee,t,g,$,E,K,u,m,A,H,d,V)},allErrors:ie,posted:V,reset:n=>L(n?.keepMessage?w($):void 0,n?.data,n?.id)}}export{ot as s};
